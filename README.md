Rewriting from scratch :)

Current version was getting too cluttered and unstable.
